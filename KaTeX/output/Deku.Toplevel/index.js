// Generated by purs version 0.15.9
import * as $foreign from "./foreign.js";
import * as Bolson_Control from "../Bolson.Control/index.js";
import * as Bolson_Core from "../Bolson.Core/index.js";
import * as Control_Alt from "../Control.Alt/index.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_Free from "../Control.Monad.Free/index.js";
import * as Control_Monad_ST_Class from "../Control.Monad.ST.Class/index.js";
import * as Control_Monad_ST_Internal from "../Control.Monad.ST.Internal/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Monoid from "../Data.Monoid/index.js";
import * as Data_Newtype from "../Data.Newtype/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Deku_Control from "../Deku.Control/index.js";
import * as Deku_Interpret from "../Deku.Interpret/index.js";
import * as Deku_SSR from "../Deku.SSR/index.js";
import * as Effect from "../Effect/index.js";
import * as FRP_Event from "../FRP.Event/index.js";
import * as FRP_Event_Class from "../FRP.Event.Class/index.js";
import * as Safe_Coerce from "../Safe.Coerce/index.js";
import * as Web_HTML from "../Web.HTML/index.js";
import * as Web_HTML_HTMLDocument from "../Web.HTML.HTMLDocument/index.js";
import * as Web_HTML_HTMLElement from "../Web.HTML.HTMLElement/index.js";
import * as Web_HTML_Window from "../Web.HTML.Window/index.js";
var keepLatest = /* #__PURE__ */ FRP_Event_Class.keepLatest(FRP_Event.eventIsEvent);
var map = /* #__PURE__ */ Data_Functor.map(FRP_Event.functorEvent);
var resume = /* #__PURE__ */ Control_Monad_Free.resume(Deku_Interpret.functorEFunctionOfFFIDOMS);
var monoidEffect = /* #__PURE__ */ Effect.monoidEffect(Data_Monoid.monoidUnit);
var mempty = /* #__PURE__ */ Data_Monoid.mempty(/* #__PURE__ */ FRP_Event.monoidEvent(/* #__PURE__ */ Data_Monoid.monoidFn(monoidEffect)));
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var bind = /* #__PURE__ */ Control_Bind.bind(Effect.bindEffect);
var mapFlipped = /* #__PURE__ */ Data_Functor.mapFlipped(Effect.functorEffect);
var liftST = /* #__PURE__ */ Control_Monad_ST_Class.liftST(Control_Monad_ST_Class.monadSTEffect);
var mempty1 = /* #__PURE__ */ Data_Monoid.mempty(/* #__PURE__ */ Effect.monoidEffect(monoidEffect));
var map1 = /* #__PURE__ */ Data_Functor.map(Data_Maybe.functorMaybe);
var $$void = /* #__PURE__ */ Data_Functor["void"](Effect.functorEffect);
var unwrap = /* #__PURE__ */ Data_Newtype.unwrap();
var eq = /* #__PURE__ */ Data_Eq.eq(Bolson_Core.eqScope);
var coerce = /* #__PURE__ */ Safe_Coerce.coerce();
var alt = /* #__PURE__ */ Control_Alt.alt(FRP_Event.altEvent);
var pure1 = /* #__PURE__ */ Control_Applicative.pure(FRP_Event.applicativeEvent);
var pure2 = /* #__PURE__ */ Control_Applicative.pure(Control_Monad_ST_Internal.applicativeST);
var map2 = /* #__PURE__ */ Data_Functor.map(Control_Monad_ST_Internal.functorST);
var void1 = /* #__PURE__ */ Data_Functor["void"](Control_Monad_ST_Internal.functorST);
var flattenToSingleEvent = function (ffi) {
    var go$prime = function (n) {
        var $52 = map(go(n));
        return function ($53) {
            return keepLatest($52($53));
        };
    };
    var go = function (n) {
        return function ($54) {
            return (function (v) {
                if (v instanceof Data_Either.Left) {
                    return keepLatest(map(f(n))(v.value0));
                };
                if (v instanceof Data_Either.Right) {
                    return mempty;
                };
                throw new Error("Failed pattern match at Deku.Toplevel (line 47, column 21 - line 49, column 22): " + [ v.constructor.name ]);
            })(resume($54));
        };
    };
    var f = function (n) {
        return function (i) {
            return go$prime(n + 1 | 0)(FRP_Event.makeEvent(function (k) {
                return function __do() {
                    Data_Unit.unit;
                    bind(i(ffi))(k)();
                    return pure(Data_Unit.unit);
                };
            }));
        };
    };
    return go$prime(0);
};
var runInElement$prime = function (elt) {
    return function (eee) {
        return function __do() {
            var ffi = Deku_Interpret.makeFFIDOMSnapshot();
            var evt = mapFlipped(liftST(Control_Monad_ST_Internal["new"](0)))((function () {
                var $55 = Deku_Control.deku(elt)(eee);
                return function ($56) {
                    return $55(Deku_Interpret.fullDOMInterpret($56));
                };
            })())();
            return FRP_Event.subscribe(flattenToSingleEvent(ffi)(evt))(function (i) {
                return i(ffi);
            })();
        };
    };
};
var runInBody$prime = function (eee) {
    return function __do() {
        var b$prime = bind(bind(Web_HTML.window)(Web_HTML_Window.document))(Web_HTML_HTMLDocument.body)();
        return Data_Maybe.maybe(mempty1)(function (elt) {
            return runInElement$prime(elt)(eee);
        })(map1(Web_HTML_HTMLElement.toElement)(b$prime))();
    };
};
var runInBody = function (a) {
    return $$void(runInBody$prime(a));
};
var __internalDekuFlatten = function (a) {
    return function (b) {
        return function (c) {
            return Bolson_Control.flatten({
                doLogic: function (pos) {
                    return function (v) {
                        return function (id) {
                            return v.sendToPos({
                                id: id,
                                pos: pos
                            });
                        };
                    };
                },
                ids: function ($57) {
                    return (function (v) {
                        return v.ids;
                    })(unwrap($57));
                },
                disconnectElement: function (v) {
                    return function (v1) {
                        return v.disconnectElement({
                            id: v1.id,
                            scope: v1.scope,
                            parent: v1.parent,
                            scopeEq: eq
                        });
                    };
                },
                toElt: function (v) {
                    return v;
                }
            })(a)(b)(coerce(c));
        };
    };
};
var hydrate$prime = function (children) {
    return function __do() {
        var ffi = Deku_Interpret.makeFFIDOMSnapshot();
        Deku_Interpret.getAllComments(ffi)();
        var di = mapFlipped(liftST(Control_Monad_ST_Internal["new"](0)))(Deku_Interpret.hydratingDOMInterpret)();
        coerce(Deku_Interpret.setHydrating)(ffi)();
        var root = $foreign.dekuRoot();
        var u = FRP_Event.subscribe(flattenToSingleEvent(ffi)(alt(pure1((unwrap(di)).makeRoot({
            id: "deku-root",
            root: root
        })))(__internalDekuFlatten({
            parent: new Data_Maybe.Just("deku-root"),
            scope: new Bolson_Core.Local("rootScope"),
            raiseId: function (v) {
                return pure2(Data_Unit.unit);
            },
            ez: true,
            pos: Data_Maybe.Nothing.value,
            dynFamily: Data_Maybe.Nothing.value
        })(di)(children))))(function (i) {
            return i(ffi);
        })();
        coerce(Deku_Interpret.unSetHydrating)(ffi)();
        return u;
    };
};
var hydrate = function (a) {
    return $$void(hydrate$prime(a));
};
var runSSR$prime = function (topTag) {
    var go = function (v) {
        return map2(Deku_SSR["ssr$prime"](topTag))(function __do() {
            var seed = Control_Monad_ST_Internal["new"](0)();
            var instr = Control_Monad_ST_Internal["new"]([  ])();
            var di = Deku_Interpret.ssrDOMInterpret(seed);
            void1(FRP_Event.subscribePure(__internalDekuFlatten({
                parent: new Data_Maybe.Just("deku-root"),
                scope: new Bolson_Core.Local("rootScope"),
                raiseId: function (v1) {
                    return pure2(Data_Unit.unit);
                },
                ez: true,
                pos: Data_Maybe.Nothing.value,
                dynFamily: Data_Maybe.Nothing.value
            })(di)(v))(function (i) {
                return i(instr);
            }))();
            return Control_Monad_ST_Internal.read(instr)();
        });
    };
    return go;
};
var runSSR = /* #__PURE__ */ runSSR$prime("body");
export {
    dekuRoot
} from "./foreign.js";
export {
    flattenToSingleEvent,
    runInElement$prime,
    runInBody$prime,
    runInBody,
    hydrate$prime,
    hydrate,
    runSSR,
    runSSR$prime,
    __internalDekuFlatten
};
