// Generated by purs version 0.15.9
import * as $foreign from "./foreign.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_State from "../Control.Monad.State/index.js";
import * as Control_Monad_State_Class from "../Control.Monad.State.Class/index.js";
import * as Control_Monad_State_Trans from "../Control.Monad.State.Trans/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_CatQueue from "../Data.CatQueue/index.js";
import * as Data_Compactable from "../Data.Compactable/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Filterable from "../Data.Filterable/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Function from "../Data.Function/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Identity from "../Data.Identity/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Monoid from "../Data.Monoid/index.js";
import * as Data_Newtype from "../Data.Newtype/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_String_Common from "../Data.String.Common/index.js";
import * as Data_Traversable from "../Data.Traversable/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Deku_Interpret from "../Deku.Interpret/index.js";
var $runtime_lazy = function (name, moduleName, init) {
    var state = 0;
    var val;
    return function (lineNumber) {
        if (state === 2) return val;
        if (state === 1) throw new ReferenceError(name + " was needed before it finished initializing (module " + moduleName + ", line " + lineNumber + ")", moduleName, lineNumber);
        state = 1;
        val = init();
        state = 2;
        return val;
    };
};
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var unwrap = /* #__PURE__ */ Data_Newtype.unwrap();
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var join = /* #__PURE__ */ Control_Bind.join(Control_Bind.bindArray);
var mapFlipped = /* #__PURE__ */ Data_Functor.mapFlipped(Data_Functor.functorArray);
var $$void = /* #__PURE__ */ Data_Functor["void"](/* #__PURE__ */ Control_Monad_State_Trans.functorStateT(Data_Identity.functorIdentity));
var modify = /* #__PURE__ */ Control_Monad_State_Class.modify(/* #__PURE__ */ Control_Monad_State_Trans.monadStateStateT(Data_Identity.monadIdentity));
var alter = /* #__PURE__ */ Data_Map_Internal.alter(Data_Ord.ordString);
var filterMap = /* #__PURE__ */ Data_Filterable.filterMap(Data_Filterable.filterableArray);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit)(/* #__PURE__ */ Control_Monad_State_Trans.bindStateT(Data_Identity.monadIdentity));
var eq1 = /* #__PURE__ */ Data_Eq.eq(/* #__PURE__ */ Data_Maybe.eqMaybe(Data_Eq.eqString));
var append1 = /* #__PURE__ */ Data_Semigroup.append(Data_CatQueue.semigroupCatQueue);
var pure = /* #__PURE__ */ Control_Applicative.pure(Data_CatQueue.applicativeCatQueue);
var map1 = /* #__PURE__ */ Data_Functor.map(Data_CatQueue.functorCatQueue);
var fromFoldable = /* #__PURE__ */ Data_CatQueue.fromFoldable(Data_Foldable.foldableArray);
var mapFlipped1 = /* #__PURE__ */ Data_Functor.mapFlipped(Data_Map_Internal.functorMap);
var bind = /* #__PURE__ */ Control_Bind.bind(Data_Maybe.bindMaybe);
var lookup = /* #__PURE__ */ Data_Map_Internal.lookup(Data_Ord.ordString);
var compact = /* #__PURE__ */ Data_Compactable.compact(Data_Compactable.compactableArray);
var applicativeStateT = /* #__PURE__ */ Control_Monad_State_Trans.applicativeStateT(Data_Identity.monadIdentity);
var traverse = /* #__PURE__ */ Data_Traversable.traverse(Data_CatQueue.traversableCatQueue)(applicativeStateT);
var for_ = /* #__PURE__ */ Data_Foldable.for_(applicativeStateT)(Data_Foldable.foldableMaybe);
var intercalate = /* #__PURE__ */ Data_Foldable.intercalate(Data_Foldable.foldableArray)(Data_Monoid.monoidString);
var foldMap = /* #__PURE__ */ Data_Foldable.foldMap(Data_Foldable.foldableArray)(Data_Monoid.monoidString);
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Map_Internal.foldableMap);
var SortableDyn = function (x) {
    return x;
};
var newtypeSortableDyn_ = {
    Coercible0: function () {
        return undefined;
    }
};
var toSortableDyns = function (a) {
    var go = function (acc) {
        return function (currentDyn) {
            return function ($383) {
                return (function (v) {
                    if (v instanceof Data_Maybe.Nothing) {
                        return {
                            acc: acc,
                            rest: [  ]
                        };
                    };
                    if (v instanceof Data_Maybe.Just) {
                        if (v.value0.head instanceof Deku_Interpret.MakeOpenDynBeacon) {
                            var ar = go([  ])(new Data_Maybe.Just({
                                id: v.value0.head.value0.id,
                                e: v.value0.head.value0
                            }))(v.value0.tail);
                            return go(append(acc)(ar.acc))(currentDyn)(ar.rest);
                        };
                        if (v.value0.head instanceof Deku_Interpret.MakeCloseDynBeacon) {
                            if (currentDyn instanceof Data_Maybe.Just) {
                                return {
                                    acc: [ {
                                        pos: currentDyn.value0.e.pos,
                                        elt: new Data_Either.Right({
                                            o: currentDyn.value0.e,
                                            a: acc,
                                            c: v.value0.head.value0
                                        })
                                    } ],
                                    rest: v.value0.tail
                                };
                            };
                            if (currentDyn instanceof Data_Maybe.Nothing) {
                                return {
                                    acc: [  ],
                                    rest: [  ]
                                };
                            };
                            throw new Error("Failed pattern match at Deku.SSR (line 58, column 34 - line 66, column 41): " + [ currentDyn.constructor.name ]);
                        };
                        var pos$prime = (function () {
                            if (v.value0.head instanceof Deku_Interpret.MakeElement) {
                                return v.value0.head.value0.pos;
                            };
                            if (v.value0.head instanceof Deku_Interpret.MakeText) {
                                return v.value0.head.value0.pos;
                            };
                            if (v.value0.head instanceof Deku_Interpret.MakePursx) {
                                return v.value0.head.value0.pos;
                            };
                            if (v.value0.head instanceof Deku_Interpret.MakeOpenDynBeacon) {
                                return v.value0.head.value0.pos;
                            };
                            if (v.value0.head instanceof Deku_Interpret.MakeCloseDynBeacon) {
                                return v.value0.head.value0.pos;
                            };
                            if (v.value0.head instanceof Deku_Interpret.SetProp) {
                                return Data_Maybe.Nothing.value;
                            };
                            if (v.value0.head instanceof Deku_Interpret.UnsetAttribute) {
                                return Data_Maybe.Nothing.value;
                            };
                            if (v.value0.head instanceof Deku_Interpret.SetText) {
                                return Data_Maybe.Nothing.value;
                            };
                            throw new Error("Failed pattern match at Deku.SSR (line 69, column 18 - line 77, column 33): " + [ v.value0.head.constructor.name ]);
                        })();
                        return go(append(acc)([ {
                            pos: pos$prime,
                            elt: new Data_Either.Left(v.value0.head)
                        } ]))(currentDyn)(v.value0.tail);
                    };
                    throw new Error("Failed pattern match at Deku.SSR (line 52, column 40 - line 79, column 15): " + [ v.constructor.name ]);
                })(Data_Array.uncons($383));
            };
        };
    };
    return (go([  ])(Data_Maybe.Nothing.value)(a)).acc;
};
var $lazy_sortSortableDyns = /* #__PURE__ */ $runtime_lazy("sortSortableDyns", "Deku.SSR", function () {
    var $384 = map(function (v) {
        if (v.elt instanceof Data_Either.Left) {
            return v;
        };
        if (v.elt instanceof Data_Either.Right) {
            return {
                pos: v.pos,
                elt: new Data_Either.Right({
                    o: v.elt.value0.o,
                    c: v.elt.value0.c,
                    a: $lazy_sortSortableDyns(47)(v.elt.value0.a)
                })
            };
        };
        throw new Error("Failed pattern match at Deku.SSR (line 44, column 5 - line 47, column 81): " + [ v.elt.constructor.name ]);
    });
    var $385 = Data_Array.sortBy(Data_Function.on(Data_Ord.compare(Data_Maybe.ordMaybe(Data_Ord.ordInt)))(function ($387) {
        return (function (v) {
            return v.pos;
        })(unwrap($387));
    }));
    return function ($386) {
        return $384($385($386));
    };
});
var sortSortableDyns = /* #__PURE__ */ $lazy_sortSortableDyns(41);
var fromSortableDyns = function (arr) {
    return join(mapFlipped(arr)(function ($388) {
        return (function (v) {
            if (v instanceof Data_Either.Left) {
                return [ v.value0 ];
            };
            if (v instanceof Data_Either.Right) {
                return append([ new Deku_Interpret.MakeOpenDynBeacon(v.value0.o) ])(append(fromSortableDyns(v.value0.a))([ new Deku_Interpret.MakeCloseDynBeacon(v.value0.c) ]));
            };
            throw new Error("Failed pattern match at Deku.SSR (line 35, column 26 - line 38, column 33): " + [ v.constructor.name ]);
        })((function (v) {
            return v.elt;
        })(unwrap($388)));
    }));
};
var ssr$prime = function (topTag) {
    return function (arr$prime) {
        var unsetting = function (id) {
            return function (key) {
                return $$void(modify(function (s) {
                    var $123 = {};
                    for (var $124 in s) {
                        if ({}.hasOwnProperty.call(s, $124)) {
                            $123[$124] = s[$124];
                        };
                    };
                    $123.idToActions = alter(function (v1) {
                        if (v1 instanceof Data_Maybe.Just) {
                            return new Data_Maybe.Just(filterMap(function (v2) {
                                if (v2 instanceof Deku_Interpret.SetProp) {
                                    if (v2.value0.key === key) {
                                        return Data_Maybe.Nothing.value;
                                    };
                                    if (Data_Boolean.otherwise) {
                                        return new Data_Maybe.Just(new Deku_Interpret.SetProp(v2.value0));
                                    };
                                };
                                return new Data_Maybe.Just(v2);
                            })(v1.value0));
                        };
                        if (v1 instanceof Data_Maybe.Nothing) {
                            return Data_Maybe.Nothing.value;
                        };
                        throw new Error("Failed pattern match at Deku.SSR (line 296, column 17 - line 307, column 37): " + [ v1.constructor.name ]);
                    })(id)(s.idToActions);
                    return $123;
                }));
            };
        };
        var setting = function (id) {
            return function (action) {
                return $$void(modify(function (s) {
                    var $128 = {};
                    for (var $129 in s) {
                        if ({}.hasOwnProperty.call(s, $129)) {
                            $128[$129] = s[$129];
                        };
                    };
                    $128.idToActions = alter(function (v1) {
                        if (v1 instanceof Data_Maybe.Just) {
                            return new Data_Maybe.Just(append(v1.value0)([ action ]));
                        };
                        if (v1 instanceof Data_Maybe.Nothing) {
                            return new Data_Maybe.Just([ action ]);
                        };
                        throw new Error("Failed pattern match at Deku.SSR (line 317, column 17 - line 319, column 45): " + [ v1.constructor.name ]);
                    })(id)(s.idToActions);
                    return $128;
                }));
            };
        };
        var rootId = Data_Maybe.fromMaybe("deku-root")(Data_Array.findMap(function (v) {
            if (v instanceof Deku_Interpret.EliminatableInstruction && v.value0 instanceof Deku_Interpret.MakeRoot) {
                return new Data_Maybe.Just(v.value0.value0.id);
            };
            return Data_Maybe.Nothing.value;
        })(arr$prime));
        var making = function (parent) {
            return function (id) {
                return function (action) {
                    return discard($$void(modify(function (s) {
                        var $137 = {};
                        for (var $138 in s) {
                            if ({}.hasOwnProperty.call(s, $138)) {
                                $137[$138] = s[$138];
                            };
                        };
                        $137.parentToChild = alter(function (v1) {
                            if (v1 instanceof Data_Maybe.Just) {
                                return new Data_Maybe.Just(append(v1.value0)([ id ]));
                            };
                            if (v1 instanceof Data_Maybe.Nothing) {
                                return new Data_Maybe.Just([ id ]);
                            };
                            throw new Error("Failed pattern match at Deku.SSR (line 283, column 19 - line 285, column 43): " + [ v1.constructor.name ]);
                        })(parent)(s.parentToChild);
                        return $137;
                    })))(function () {
                        return setting(id)(action);
                    });
                };
            };
        };
        var instructionsToRenderableInstructions = function (aa) {
            var sendPos = function (id$prime) {
                return function (pos$prime) {
                    return function (v) {
                        if (v instanceof Deku_Interpret.MakeElement) {
                            var $141 = v.value0.id === id$prime || eq1(v.value0.dynFamily)(new Data_Maybe.Just(v.value0.id));
                            if ($141) {
                                return new Deku_Interpret.MakeElement({
                                    id: v.value0.id,
                                    scope: v.value0.scope,
                                    parent: v.value0.parent,
                                    tag: v.value0.tag,
                                    pos: new Data_Maybe.Just(pos$prime),
                                    dynFamily: v.value0.dynFamily
                                });
                            };
                            return v;
                        };
                        if (v instanceof Deku_Interpret.MakeText) {
                            var $145 = v.value0.id === id$prime || eq1(v.value0.dynFamily)(new Data_Maybe.Just(v.value0.id));
                            if ($145) {
                                return new Deku_Interpret.MakeText({
                                    id: v.value0.id,
                                    pos: new Data_Maybe.Just(pos$prime),
                                    scope: v.value0.scope,
                                    parent: v.value0.parent,
                                    dynFamily: v.value0.dynFamily
                                });
                            };
                            return v;
                        };
                        if (v instanceof Deku_Interpret.MakePursx) {
                            var $149 = v.value0.id === id$prime || eq1(v.value0.dynFamily)(new Data_Maybe.Just(v.value0.id));
                            if ($149) {
                                return new Deku_Interpret.MakePursx({
                                    id: v.value0.id,
                                    parent: v.value0.parent,
                                    html: v.value0.html,
                                    scope: v.value0.scope,
                                    pos: new Data_Maybe.Just(pos$prime),
                                    pxScope: v.value0.pxScope,
                                    verb: v.value0.verb,
                                    cache: v.value0.cache,
                                    dynFamily: v.value0.dynFamily
                                });
                            };
                            return v;
                        };
                        if (v instanceof Deku_Interpret.MakeOpenDynBeacon) {
                            var $153 = v.value0.id === id$prime || eq1(v.value0.dynFamily)(new Data_Maybe.Just(v.value0.id));
                            if ($153) {
                                return new Deku_Interpret.MakeOpenDynBeacon({
                                    id: v.value0.id,
                                    parent: v.value0.parent,
                                    pos: new Data_Maybe.Just(pos$prime),
                                    scope: v.value0.scope,
                                    dynFamily: v.value0.dynFamily
                                });
                            };
                            return v;
                        };
                        if (v instanceof Deku_Interpret.MakeCloseDynBeacon) {
                            var $157 = v.value0.id === id$prime || eq1(v.value0.dynFamily)(new Data_Maybe.Just(v.value0.id));
                            if ($157) {
                                return new Deku_Interpret.MakeCloseDynBeacon({
                                    id: v.value0.id,
                                    parent: v.value0.parent,
                                    pos: new Data_Maybe.Just(pos$prime),
                                    scope: v.value0.scope,
                                    dynFamily: v.value0.dynFamily
                                });
                            };
                            return v;
                        };
                        if (v instanceof Deku_Interpret.SetText) {
                            return v;
                        };
                        if (v instanceof Deku_Interpret.SetProp) {
                            return v;
                        };
                        if (v instanceof Deku_Interpret.UnsetAttribute) {
                            return v;
                        };
                        throw new Error("Failed pattern match at Deku.SSR (line 201, column 24 - line 224, column 36): " + [ v.constructor.name ]);
                    };
                };
            };
            var removeParent = function (id$prime) {
                return function (v) {
                    if (v instanceof Deku_Interpret.MakeElement) {
                        var $165 = v.value0.id === id$prime || eq1(v.value0.dynFamily)(new Data_Maybe.Just(v.value0.id));
                        if ($165) {
                            return new Deku_Interpret.MakeElement({
                                id: v.value0.id,
                                scope: v.value0.scope,
                                parent: Data_Maybe.Nothing.value,
                                tag: v.value0.tag,
                                pos: v.value0.pos,
                                dynFamily: v.value0.dynFamily
                            });
                        };
                        return v;
                    };
                    if (v instanceof Deku_Interpret.MakeText) {
                        var $169 = v.value0.id === id$prime || eq1(v.value0.dynFamily)(new Data_Maybe.Just(v.value0.id));
                        if ($169) {
                            return new Deku_Interpret.MakeText({
                                id: v.value0.id,
                                pos: v.value0.pos,
                                scope: v.value0.scope,
                                parent: Data_Maybe.Nothing.value,
                                dynFamily: v.value0.dynFamily
                            });
                        };
                        return v;
                    };
                    if (v instanceof Deku_Interpret.MakePursx) {
                        var $173 = v.value0.id === id$prime || eq1(v.value0.dynFamily)(new Data_Maybe.Just(v.value0.id));
                        if ($173) {
                            return new Deku_Interpret.MakePursx({
                                id: v.value0.id,
                                parent: Data_Maybe.Nothing.value,
                                html: v.value0.html,
                                scope: v.value0.scope,
                                pos: v.value0.pos,
                                pxScope: v.value0.pxScope,
                                verb: v.value0.verb,
                                cache: v.value0.cache,
                                dynFamily: v.value0.dynFamily
                            });
                        };
                        return v;
                    };
                    if (v instanceof Deku_Interpret.MakeOpenDynBeacon) {
                        var $177 = v.value0.id === id$prime || eq1(v.value0.dynFamily)(new Data_Maybe.Just(v.value0.id));
                        if ($177) {
                            return new Deku_Interpret.MakeOpenDynBeacon({
                                id: v.value0.id,
                                parent: Data_Maybe.Nothing.value,
                                pos: v.value0.pos,
                                scope: v.value0.scope,
                                dynFamily: v.value0.dynFamily
                            });
                        };
                        return v;
                    };
                    if (v instanceof Deku_Interpret.MakeCloseDynBeacon) {
                        var $181 = v.value0.id === id$prime || eq1(v.value0.dynFamily)(new Data_Maybe.Just(v.value0.id));
                        if ($181) {
                            return new Deku_Interpret.MakeCloseDynBeacon({
                                id: v.value0.id,
                                parent: Data_Maybe.Nothing.value,
                                pos: v.value0.pos,
                                scope: v.value0.scope,
                                dynFamily: v.value0.dynFamily
                            });
                        };
                        return v;
                    };
                    if (v instanceof Deku_Interpret.SetText) {
                        return v;
                    };
                    if (v instanceof Deku_Interpret.SetProp) {
                        return v;
                    };
                    if (v instanceof Deku_Interpret.UnsetAttribute) {
                        return v;
                    };
                    throw new Error("Failed pattern match at Deku.SSR (line 225, column 24 - line 248, column 36): " + [ v.constructor.name ]);
                };
            };
            var moveClosingToEnd = function (staging1) {
                return function (staging2) {
                    return function (dbc) {
                        return function ($389) {
                            return (function (v) {
                                if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.MakeOpenDynBeacon) {
                                    if (eq1(v.value0.value0.value0.dynFamily)(new Data_Maybe.Just(dbc.id))) {
                                        return moveClosingToEnd(Data_CatQueue.snoc(append1(staging1)(staging2))(v.value0.value0))(Data_CatQueue.empty)(dbc)(v.value0.value1);
                                    };
                                    if (Data_Boolean.otherwise) {
                                        return moveClosingToEnd(staging1)(Data_CatQueue.snoc(staging2)(v.value0.value0))(dbc)(v.value0.value1);
                                    };
                                };
                                if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.MakeCloseDynBeacon) {
                                    if (eq1(v.value0.value0.value0.dynFamily)(new Data_Maybe.Just(dbc.id))) {
                                        return moveClosingToEnd(Data_CatQueue.snoc(append1(staging1)(staging2))(v.value0.value0))(Data_CatQueue.empty)(dbc)(v.value0.value1);
                                    };
                                    if (Data_Boolean.otherwise) {
                                        return moveClosingToEnd(staging1)(Data_CatQueue.snoc(staging2)(v.value0.value0))(dbc)(v.value0.value1);
                                    };
                                };
                                if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.MakeText) {
                                    if (eq1(v.value0.value0.value0.dynFamily)(new Data_Maybe.Just(dbc.id))) {
                                        return moveClosingToEnd(Data_CatQueue.snoc(append1(staging1)(staging2))(v.value0.value0))(Data_CatQueue.empty)(dbc)(v.value0.value1);
                                    };
                                    if (Data_Boolean.otherwise) {
                                        return moveClosingToEnd(staging1)(Data_CatQueue.snoc(staging2)(v.value0.value0))(dbc)(v.value0.value1);
                                    };
                                };
                                if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.MakePursx) {
                                    if (eq1(v.value0.value0.value0.dynFamily)(new Data_Maybe.Just(dbc.id))) {
                                        return moveClosingToEnd(Data_CatQueue.snoc(append1(staging1)(staging2))(v.value0.value0))(Data_CatQueue.empty)(dbc)(v.value0.value1);
                                    };
                                    if (Data_Boolean.otherwise) {
                                        return moveClosingToEnd(staging1)(Data_CatQueue.snoc(staging2)(v.value0.value0))(dbc)(v.value0.value1);
                                    };
                                };
                                if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.MakeElement) {
                                    if (eq1(v.value0.value0.value0.dynFamily)(new Data_Maybe.Just(dbc.id))) {
                                        return moveClosingToEnd(Data_CatQueue.snoc(append1(staging1)(staging2))(v.value0.value0))(Data_CatQueue.empty)(dbc)(v.value0.value1);
                                    };
                                    if (Data_Boolean.otherwise) {
                                        return moveClosingToEnd(staging1)(Data_CatQueue.snoc(staging2)(v.value0.value0))(dbc)(v.value0.value1);
                                    };
                                };
                                if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.SetProp) {
                                    return moveClosingToEnd(staging1)(Data_CatQueue.snoc(staging2)(v.value0.value0))(dbc)(v.value0.value1);
                                };
                                if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.UnsetAttribute) {
                                    return moveClosingToEnd(staging1)(Data_CatQueue.snoc(staging2)(v.value0.value0))(dbc)(v.value0.value1);
                                };
                                if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.SetText) {
                                    return moveClosingToEnd(staging1)(Data_CatQueue.snoc(staging2)(v.value0.value0))(dbc)(v.value0.value1);
                                };
                                if (v instanceof Data_Maybe.Nothing) {
                                    return append1(staging1)(append1(pure(new Deku_Interpret.MakeCloseDynBeacon({
                                        id: dbc.id + "%-%",
                                        parent: dbc.parent,
                                        pos: dbc.pos,
                                        scope: dbc.scope,
                                        dynFamily: dbc.dynFamily
                                    })))(staging2));
                                };
                                throw new Error("Failed pattern match at Deku.SSR (line 123, column 63 - line 178, column 20): " + [ v.constructor.name ]);
                            })(Data_CatQueue.uncons($389));
                        };
                    };
                };
            };
            var moveClosingsToEnd = function (cl) {
                return function ($390) {
                    return (function (v) {
                        if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.MakeCloseDynBeacon) {
                            return moveClosingsToEnd(moveClosingToEnd(Data_CatQueue.empty)(Data_CatQueue.empty)(v.value0.value0.value0)(cl))(v.value0.value1);
                        };
                        if (v instanceof Data_Maybe.Just) {
                            return moveClosingsToEnd(Data_CatQueue.cons(v.value0.value0)(cl))(v.value0.value1);
                        };
                        if (v instanceof Data_Maybe.Nothing) {
                            return cl;
                        };
                        throw new Error("Failed pattern match at Deku.SSR (line 110, column 45 - line 115, column 20): " + [ v.constructor.name ]);
                    })(Data_CatQueue.unsnoc($390));
                };
            };
            var doDeleteFromCache = function (cl) {
                return function (id$prime) {
                    return function ($391) {
                        return (function (v) {
                            if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.MakeElement) {
                                var $230 = v.value0.value0.value0.id === id$prime;
                                if ($230) {
                                    return doDeleteFromCache(cl)(id$prime)(v.value0.value1);
                                };
                                return doDeleteFromCache(Data_CatQueue.snoc(cl)(v.value0.value0))(id$prime)(v.value0.value1);
                            };
                            if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.MakeText) {
                                var $236 = v.value0.value0.value0.id === id$prime;
                                if ($236) {
                                    return doDeleteFromCache(cl)(id$prime)(v.value0.value1);
                                };
                                return doDeleteFromCache(Data_CatQueue.snoc(cl)(v.value0.value0))(id$prime)(v.value0.value1);
                            };
                            if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.MakePursx) {
                                var $242 = v.value0.value0.value0.id === id$prime;
                                if ($242) {
                                    return doDeleteFromCache(cl)(id$prime)(v.value0.value1);
                                };
                                return doDeleteFromCache(Data_CatQueue.snoc(cl)(v.value0.value0))(id$prime)(v.value0.value1);
                            };
                            if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.MakeOpenDynBeacon) {
                                var $248 = v.value0.value0.value0.id === id$prime;
                                if ($248) {
                                    return doDeleteFromCache(cl)(id$prime)(v.value0.value1);
                                };
                                return doDeleteFromCache(Data_CatQueue.snoc(cl)(v.value0.value0))(id$prime)(v.value0.value1);
                            };
                            if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.MakeCloseDynBeacon) {
                                var $254 = v.value0.value0.value0.id === id$prime;
                                if ($254) {
                                    return doDeleteFromCache(cl)(id$prime)(v.value0.value1);
                                };
                                return doDeleteFromCache(Data_CatQueue.snoc(cl)(v.value0.value0))(id$prime)(v.value0.value1);
                            };
                            if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.SetProp) {
                                var $260 = v.value0.value0.value0.id === id$prime;
                                if ($260) {
                                    return doDeleteFromCache(cl)(id$prime)(v.value0.value1);
                                };
                                return doDeleteFromCache(Data_CatQueue.snoc(cl)(v.value0.value0))(id$prime)(v.value0.value1);
                            };
                            if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.SetText) {
                                var $266 = v.value0.value0.value0.id === id$prime;
                                if ($266) {
                                    return doDeleteFromCache(cl)(id$prime)(v.value0.value1);
                                };
                                return doDeleteFromCache(Data_CatQueue.snoc(cl)(v.value0.value0))(id$prime)(v.value0.value1);
                            };
                            if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.UnsetAttribute) {
                                var $272 = v.value0.value0.value0.id === id$prime;
                                if ($272) {
                                    return doDeleteFromCache(cl)(id$prime)(v.value0.value1);
                                };
                                return doDeleteFromCache(Data_CatQueue.snoc(cl)(v.value0.value0))(id$prime)(v.value0.value1);
                            };
                            if (v instanceof Data_Maybe.Nothing) {
                                return cl;
                            };
                            throw new Error("Failed pattern match at Deku.SSR (line 250, column 49 - line 275, column 20): " + [ v.constructor.name ]);
                        })(Data_CatQueue.uncons($391));
                    };
                };
            };
            var doEliminations = function (cl) {
                return function ($392) {
                    return (function (v) {
                        if (v instanceof Data_Maybe.Just && v.value0.value0 instanceof Deku_Interpret.RenderableInstruction) {
                            return doEliminations(Data_CatQueue.snoc(cl)(v.value0.value0.value0))(v.value0.value1);
                        };
                        if (v instanceof Data_Maybe.Just && (v.value0.value0 instanceof Deku_Interpret.EliminatableInstruction && v.value0.value0.value0 instanceof Deku_Interpret.SendToPos)) {
                            return doEliminations(map1(sendPos(v.value0.value0.value0.value0.id)(v.value0.value0.value0.value0.pos))(cl))(v.value0.value1);
                        };
                        if (v instanceof Data_Maybe.Just && (v.value0.value0 instanceof Deku_Interpret.EliminatableInstruction && v.value0.value0.value0 instanceof Deku_Interpret.MakeRoot)) {
                            return doEliminations(cl)(v.value0.value1);
                        };
                        if (v instanceof Data_Maybe.Just && (v.value0.value0 instanceof Deku_Interpret.EliminatableInstruction && v.value0.value0.value0 instanceof Deku_Interpret.GiveNewParent)) {
                            return doEliminations(cl)(v.value0.value1);
                        };
                        if (v instanceof Data_Maybe.Just && (v.value0.value0 instanceof Deku_Interpret.EliminatableInstruction && v.value0.value0.value0 instanceof Deku_Interpret.DisconnectElement)) {
                            return doEliminations(map1(removeParent(v.value0.value0.value0.value0.id))(cl))(v.value0.value1);
                        };
                        if (v instanceof Data_Maybe.Just && (v.value0.value0 instanceof Deku_Interpret.EliminatableInstruction && v.value0.value0.value0 instanceof Deku_Interpret.RemoveDynBeacon)) {
                            return doEliminations(doDeleteFromCache(Data_CatQueue.empty)(v.value0.value0.value0.value0.id)(cl))(v.value0.value1);
                        };
                        if (v instanceof Data_Maybe.Just && (v.value0.value0 instanceof Deku_Interpret.EliminatableInstruction && v.value0.value0.value0 instanceof Deku_Interpret.DeleteFromCache)) {
                            return doEliminations(doDeleteFromCache(Data_CatQueue.empty)(v.value0.value0.value0.value0.id)(cl))(v.value0.value1);
                        };
                        if (v instanceof Data_Maybe.Nothing) {
                            return cl;
                        };
                        throw new Error("Failed pattern match at Deku.SSR (line 179, column 42 - line 200, column 20): " + [ v.constructor.name ]);
                    })(Data_CatQueue.uncons($392));
                };
            };
            var asList = fromFoldable(aa);
            var beforeClosingsMoved = doEliminations(Data_CatQueue.empty)(asList);
            var go = moveClosingsToEnd(Data_CatQueue.empty)(beforeClosingsMoved);
            return go;
        };
        var arr = instructionsToRenderableInstructions(arr$prime);
        var v = (function (x) {
            return {
                parentToChild: mapFlipped1(x.parentToChild)((function () {
                    var $393 = map(function (v1) {
                        if (v1 instanceof Deku_Interpret.MakeElement) {
                            return v1.value0.id;
                        };
                        if (v1 instanceof Deku_Interpret.MakeText) {
                            return v1.value0.id;
                        };
                        if (v1 instanceof Deku_Interpret.MakePursx) {
                            return v1.value0.id;
                        };
                        if (v1 instanceof Deku_Interpret.MakeOpenDynBeacon) {
                            return v1.value0.id;
                        };
                        if (v1 instanceof Deku_Interpret.MakeCloseDynBeacon) {
                            return v1.value0.id;
                        };
                        if (v1 instanceof Deku_Interpret.SetProp) {
                            return v1.value0.id;
                        };
                        if (v1 instanceof Deku_Interpret.SetText) {
                            return v1.value0.id;
                        };
                        if (v1 instanceof Deku_Interpret.UnsetAttribute) {
                            return v1.value0.id;
                        };
                        throw new Error("Failed pattern match at Deku.SSR (line 336, column 23 - line 344, column 52): " + [ v1.constructor.name ]);
                    });
                    var $394 = map(function (i) {
                        return bind(lookup(i)(x.idToActions))(Data_Array.head);
                    });
                    return function ($395) {
                        return $393(fromSortableDyns(sortSortableDyns(toSortableDyns(compact($394($395))))));
                    };
                })()),
                idToActions: x.idToActions
            };
        })(Control_Monad_State.execState(traverse(function (i) {
            if (i instanceof Deku_Interpret.MakeElement) {
                return for_(i.value0.parent)(function (p) {
                    return making(p)(i.value0.id)(i);
                });
            };
            if (i instanceof Deku_Interpret.MakeText) {
                return for_(i.value0.parent)(function (p) {
                    return making(p)(i.value0.id)(i);
                });
            };
            if (i instanceof Deku_Interpret.MakePursx) {
                return for_(i.value0.parent)(function (p) {
                    return making(p)(i.value0.id)(i);
                });
            };
            if (i instanceof Deku_Interpret.MakeOpenDynBeacon) {
                return for_(i.value0.parent)(function (p) {
                    return making(p)(i.value0.id)(i);
                });
            };
            if (i instanceof Deku_Interpret.MakeCloseDynBeacon) {
                return for_(i.value0.parent)(function (p) {
                    return making(p)(i.value0.id)(i);
                });
            };
            if (i instanceof Deku_Interpret.SetProp) {
                return setting(i.value0.id)(i);
            };
            if (i instanceof Deku_Interpret.SetText) {
                return setting(i.value0.id)(i);
            };
            if (i instanceof Deku_Interpret.UnsetAttribute) {
                return unsetting(i.value0.id)(i.value0.key);
            };
            throw new Error("Failed pattern match at Deku.SSR (line 352, column 19 - line 364, column 61): " + [ i.constructor.name ]);
        })(arr))({
            parentToChild: Data_Map_Internal.empty,
            idToActions: Data_Map_Internal.empty
        }));
        var hasMake = function (a) {
            return Data_Maybe.isJust(Data_Array.find(function (v1) {
                if (v1 instanceof Deku_Interpret.MakeElement) {
                    return true;
                };
                if (v1 instanceof Deku_Interpret.MakeText) {
                    return true;
                };
                if (v1 instanceof Deku_Interpret.MakeOpenDynBeacon) {
                    return true;
                };
                if (v1 instanceof Deku_Interpret.MakeCloseDynBeacon) {
                    return true;
                };
                return false;
            })(a));
        };
        var eltTag = function (i2a) {
            return Data_Maybe.fromMaybe("")(Data_Array.findMap(function (v1) {
                if (v1 instanceof Deku_Interpret.MakeElement) {
                    return new Data_Maybe.Just(v1.value0.tag);
                };
                return Data_Maybe.Nothing.value;
            })(i2a));
        };
        var eltAtts = function (i2a) {
            return intercalate(" ")(filterMap(function (v1) {
                if (v1 instanceof Deku_Interpret.SetProp) {
                    return new Data_Maybe.Just(v1.value0.key + ("=\"" + (v1.value0.value + "\"")));
                };
                return Data_Maybe.Nothing.value;
            })(i2a));
        };
        var singleElt = function (id) {
            return Data_Maybe.maybe("")(function (i2a) {
                var makeText = function (v1) {
                    return Data_Maybe.fromMaybe("")(Data_Array.findMap(function (v2) {
                        if (v2 instanceof Deku_Interpret.SetText) {
                            return new Data_Maybe.Just($foreign.encodedString(v2.value0.text) + ("<!--" + (id + "-->")));
                        };
                        return new Data_Maybe.Just("<!--" + (id + "-->"));
                    })(i2a));
                };
                var makeOpenDynBeacon = function (v1) {
                    return "<!--%-%" + (id + "-->");
                };
                var makeElt = function (v1) {
                    var tag = eltTag(i2a);
                    var atts = eltAtts(i2a);
                    return "<" + (tag + (" " + (atts + (" data-deku-ssr=\"" + (id + ("\">" + (o(id) + ("</" + (tag + ">")))))))));
                };
                var makeCloseDynBeacon = function (v1) {
                    return "<!--%-%" + (id + "-->");
                };
                var v1 = Data_Array.index(i2a)(0);
                if (v1 instanceof Data_Maybe.Just && v1.value0 instanceof Deku_Interpret.SetText) {
                    return makeText(Data_Unit.unit);
                };
                if (v1 instanceof Data_Maybe.Just && v1.value0 instanceof Deku_Interpret.MakeText) {
                    return makeText(Data_Unit.unit);
                };
                if (v1 instanceof Data_Maybe.Just && v1.value0 instanceof Deku_Interpret.MakeOpenDynBeacon) {
                    return makeOpenDynBeacon(Data_Unit.unit);
                };
                if (v1 instanceof Data_Maybe.Just && v1.value0 instanceof Deku_Interpret.MakeCloseDynBeacon) {
                    return makeCloseDynBeacon(Data_Unit.unit);
                };
                if (v1 instanceof Data_Maybe.Just && v1.value0 instanceof Deku_Interpret.MakePursx) {
                    return $foreign.doPursxReplacements(v1.value0.value0);
                };
                return makeElt(Data_Unit.unit);
            })(lookup(id)(v.idToActions));
        };
        var o = function (id) {
            var elts = Data_Maybe.fromMaybe([  ])(lookup(id)(v.parentToChild));
            return foldMap(singleElt)(elts);
        };
        var oo = function (id) {
            return foldl(function (b) {
                return function (a) {
                    var v1 = hasMake(a);
                    if (v1) {
                        return b;
                    };
                    if (!v1) {
                        return Data_String_Common.replace("data-deku-ssr")(eltAtts(a) + " data-deku-ssr")(b);
                    };
                    throw new Error("Failed pattern match at Deku.SSR (line 386, column 17 - line 390, column 14): " + [ v1.constructor.name ]);
                };
            })(o(id))(v.idToActions);
        };
        return "<" + (topTag + (" data-deku-ssr=\"deku-root\" data-deku-root=\"" + (rootId + ("\">" + (oo(rootId) + ("</" + (topTag + ">")))))));
    };
};
var ssr = /* #__PURE__ */ ssr$prime("body");
export {
    encodedString,
    doPursxReplacements
} from "./foreign.js";
export {
    SortableDyn,
    fromSortableDyns,
    sortSortableDyns,
    toSortableDyns,
    ssr,
    ssr$prime,
    newtypeSortableDyn_
};
